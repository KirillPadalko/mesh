# Service Worker Debugging Guide

## Ошибка: "Unchecked runtime.lastError"

Эта ошибка обычно **НЕ связана с вашим кодом** и возникает по следующим причинам:

### 1. Расширения браузера (САМАЯ ЧАСТАЯ ПРИЧИНА)

Расширения Chrome (блокировщики рекламы, менеджеры паролей, VPN и т.д.) могут вызывать эту ошибку.

**Решение:**
- Откройте приложение в режиме инкогнито (Ctrl+Shift+N)
- Если ошибка исчезла - проблема в расширениях
- Отключите расширения по одному, чтобы найти виновника

### 2. Проверка Service Worker

Откройте DevTools → Application → Service Workers

**Что сделано:**
- ✅ Добавлена обработка ошибок в fetch handler
- ✅ Добавлен фильтр для non-GET запросов
- ✅ Добавлен message handler с правильной обработкой
- ✅ Улучшено логирование для отладки
- ✅ Добавлены утилиты для диагностики

### 3. Утилиты отладки

В консоли браузера доступны утилиты через `window.swDebug`:

```javascript
// Вывести полную информацию о SW
await swDebug.printDebugInfo()

// Проверить статус
await swDebug.getStatus()

// Контролируется ли страница SW?
swDebug.isControlled()

// Принудительное обновление SW
await swDebug.forceUpdate()

// ПОЛНАЯ ОЧИСТКА (затем перезагрузите страницу)
await swDebug.fullReset()
```

### 4. Ручная очистка Service Worker

Если проблема сохраняется:

1. Откройте DevTools (F12)
2. Application → Service Workers
3. Нажмите "Unregister" для всех SW
4. Application → Cache Storage → Delete All
5. Перезагрузите страницу (Ctrl+Shift+R)

### 5. Проверка в разных браузерах

Попробуйте открыть в другом браузере:
- Chrome
- Firefox
- Edge
- Safari (если на Mac/iOS)

Если ошибка только в одном браузере - проблема в нём или его расширениях.

## Дополнительная информация

### Обновленные файлы:

1. **`public/sw.js`**
   - Улучшена обработка ошибок
   - Добавлен message handler
   - Обновлена версия кэша до v2

2. **`src/serviceWorkerRegistration.ts`**
   - Добавлено отслеживание обновлений
   - Улучшено логирование
   - Добавлена автоматическая проверка обновлений

3. **`src/utils/swDebug.ts`** (НОВЫЙ)
   - Утилиты для отладки
   - Доступны через `window.swDebug`

### Если ошибка НЕ исчезла:

1. Проверьте логи в консоли - там может быть больше информации
2. Попробуйте в режиме инкогнито
3. Проверьте вкладку Network в DevTools на предмет неудачных запросов
4. Используйте `swDebug.printDebugInfo()` для диагностики

### Важно:

Эта ошибка **не влияет на работу приложения** в большинстве случаев. Это предупреждение, а не критическая ошибка.
